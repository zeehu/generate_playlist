# generate_playlist: ç”Ÿæˆå¼æ­Œå•æ¨èç³»ç»Ÿ

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªå®Œæ•´çš„ç«¯åˆ°ç«¯ï¼ˆEnd-to-Endï¼‰æœºå™¨å­¦ä¹ æµç¨‹ï¼Œç”¨äºæ ¹æ®ç”¨æˆ·è¾“å…¥çš„æ–‡æœ¬ï¼ˆå¦‚æ­Œå•æ ‡é¢˜ã€æƒ…ç»ªæè¿°ï¼‰ç”Ÿæˆä¸€ä¸ªæ¨èçš„æ­Œæ›²åºåˆ—ã€‚ç³»ç»Ÿæ ¸å¿ƒé‡‡ç”¨ä¸¤é˜¶æ®µæ¨¡å‹æ¶æ„ï¼š

1.  **RQ-VAE**: é¦–å…ˆï¼Œä½¿ç”¨æ®‹å·®é‡åŒ–è‡ªç¼–ç å™¨ï¼ˆRQ-VAEï¼‰å°†æ¯é¦–æ­Œæ›²é«˜ç»´ã€è¿ç»­çš„å‘é‡ï¼ˆä¾‹å¦‚100ç»´ï¼‰å‹ç¼©ä¸ºä½ç»´ã€ç¦»æ•£çš„â€œè¯­ä¹‰IDâ€ã€‚è¿™ç›¸å½“äºä¸ºæ¯é¦–æ­Œæ›²å­¦ä¹ ä¸€ä¸ªç‹¬ç‰¹çš„ã€ç”±å‡ ä¸ªæ•°å­—ç»„æˆçš„â€œä»£å·â€ã€‚
2.  **T5 æ¨¡å‹**: ç„¶åï¼Œä½¿ç”¨ä¸€ä¸ªå¼ºå¤§çš„åºåˆ—åˆ°åºåˆ—æ¨¡å‹ï¼ˆT5ï¼‰ï¼Œå­¦ä¹ ä»è¾“å…¥çš„æ–‡æœ¬æè¿°åˆ°ç›®æ ‡æ­Œæ›²è¯­ä¹‰IDåºåˆ—çš„æ˜ å°„å…³ç³»ã€‚

## ğŸš€ é¡¹ç›®ç‰¹ç‚¹

- **ç«¯åˆ°ç«¯æµç¨‹**: åŒ…å«ä»æ•°æ®å¤„ç†ã€æ¨¡å‹è®­ç»ƒã€æ•ˆæœè¯„ä¼°åˆ°æœ€ç»ˆæ¨ç†æ¼”ç¤ºçš„å®Œæ•´æ­¥éª¤ã€‚
- **ä¸¤é˜¶æ®µæ¨¡å‹**: è§£è€¦äº†ç‰©å“è¡¨ç¤ºå­¦ä¹ ï¼ˆRQ-VAEï¼‰å’Œåºåˆ—ç”Ÿæˆï¼ˆT5ï¼‰ï¼Œä½¿æµç¨‹æ›´æ¸…æ™°ï¼Œæ˜“äºè°ƒè¯•å’Œæ‰©å±•ã€‚
- **é…ç½®é©±åŠ¨**: æ‰€æœ‰å…³é”®å‚æ•°ï¼ˆå¦‚æ–‡ä»¶è·¯å¾„ã€æ¨¡å‹è¶…å‚ï¼‰éƒ½åœ¨ `config.py` ä¸­ç»Ÿä¸€ç®¡ç†ã€‚
- **å¤šGPUæ”¯æŒ**: T5æ¨¡å‹è®­ç»ƒè„šæœ¬å†…ç½®äº†å¯¹åˆ†å¸ƒå¼è®­ç»ƒçš„æ”¯æŒï¼Œå¯å……åˆ†åˆ©ç”¨å¤šGPUèµ„æºã€‚

## ğŸ“ é¡¹ç›®ç»“æ„

```
.
â”œâ”€â”€ config.py           # ä»»åŠ¡ä¸“å±çš„é…ç½®æ–‡ä»¶
â”œâ”€â”€ train_rqvae.py      # é˜¶æ®µ1: è®­ç»ƒRQ-VAEï¼Œç”Ÿæˆè¯­ä¹‰ID
â”œâ”€â”€ evaluate_rqvae.py   # é˜¶æ®µ1b: è¯„ä¼°è¯­ä¹‰IDè´¨é‡
â”œâ”€â”€ prepare_corpus.py   # é˜¶æ®µ2: ç”ŸæˆT5æ¨¡å‹è®­ç»ƒè¯­æ–™
â”œâ”€â”€ train_tiger.py      # é˜¶æ®µ3: è®­ç»ƒT5ç”Ÿæˆæ¨¡å‹
â”œâ”€â”€ evaluate_tiger.py   # é˜¶æ®µ4: è¯„ä¼°T5æ¨¡å‹æ€§èƒ½
â”œâ”€â”€ generate_playlist.py# é˜¶æ®µ5: äº¤äº’å¼æ¨ç†ä¸æ¼”ç¤º
â”œâ”€â”€ requirements.txt      # (éœ€è¦æ‚¨æ‰‹åŠ¨åˆ›å»º)
â”œâ”€â”€ models/                 # (è‡ªåŠ¨ç”Ÿæˆ) å­˜å‚¨è®­ç»ƒå¥½çš„æ¨¡å‹æ–‡ä»¶
â”œâ”€â”€ outputs/                # (è‡ªåŠ¨ç”Ÿæˆ) å­˜å‚¨ä¸­é—´ç”Ÿæˆæ–‡ä»¶
â””â”€â”€ logs/                   # (è‡ªåŠ¨ç”Ÿæˆ) å­˜å‚¨è®­ç»ƒæ—¥å¿—
```

## âš™ï¸ ç¯å¢ƒä¸å®‰è£…

### 1. å…‹éš†é¡¹ç›®
```bash
git clone https://github.com/zeehu/generate_playlist.git
cd generate_playlist
```

### 2. ç¯å¢ƒé…ç½®
- **Python ç‰ˆæœ¬**: æ¨èä½¿ç”¨ Python 3.9 æˆ–æ›´é«˜ç‰ˆæœ¬ã€‚
- **åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ** (æ¨è):
    ```bash
    python -m venv venv
    source venv/bin/activate
    ```

### 3. å®‰è£…ä¾èµ–
æ‚¨éœ€è¦åˆ›å»ºä¸€ä¸ª `requirements.txt` æ–‡ä»¶ï¼ŒåŒ…å«ä»¥ä¸‹æ ¸å¿ƒä¾èµ–ã€‚å»ºè®®ä½¿ç”¨ `pip` å•ç‹¬å®‰è£… `torch` ä»¥ç¡®ä¿ç‰ˆæœ¬å…¼å®¹æ€§ã€‚

```bash
# å¼ºçƒˆå»ºè®®å…ˆè¿è¡Œæ­¤å‘½ä»¤ï¼Œä»¥ç¡®ä¿ torch å’Œ torchvision ç‰ˆæœ¬å…¼å®¹
pip install --upgrade torch torchvision

# ç„¶åé€šè¿‡ requirements.txt å®‰è£…å…¶ä½™ä¾èµ–
pip install -r requirements.txt
```

```
# requirements.txt
transformers
pandas
numpy
scikit-learn
evaluate
rouge_score
tqdm
sentencepiece
faiss-cpu # æˆ– faiss-gpu
accelerate

## ğŸ’¿ æ•°æ®å‡†å¤‡

åœ¨è¿è¡Œä»»ä½•è„šæœ¬ä¹‹å‰ï¼Œæ‚¨å¿…é¡»å‡†å¤‡å¥½ä»¥ä¸‹å››ä»½æ•°æ®æ–‡ä»¶ï¼Œå¹¶**åœ¨ `config.py` ä¸­é…ç½®å¥½å®ƒä»¬çš„è·¯å¾„**ã€‚

1.  **æ­Œæ›²å‘é‡æ–‡ä»¶**: `song_vectors.csv` (ç¤ºä¾‹å)
    *   æ ¼å¼: `mixsongid,v_0,v_1,...,v_99`
2.  **æ­Œå•ä¿¡æ¯æ–‡ä»¶**: `gen_playlist_info.csv` (ç¤ºä¾‹å)
    *   æ ¼å¼: `glid,listname,tag_list`
3.  **æ­Œå•-æ­Œæ›²å…³ç³»æ–‡ä»¶**: `gen_playlist_song.csv` (ç¤ºä¾‹å)
    *   æ ¼å¼: `special_gid,mixsongid`
4.  **æ­Œæ›²å…ƒä¿¡æ¯æ–‡ä»¶**: `gen_song_info.csv` (ç¤ºä¾‹å)
    *   æ ¼å¼: `mixsongid,song_name,singer_name`

#### **å…³é”®é…ç½®æ­¥éª¤**

æ‰“å¼€ `config.py` æ–‡ä»¶ï¼Œæ‰¾åˆ° `DataConfig` å’Œ `SongRQVAEConfig` ç±»ï¼Œå¹¶å¡«å…¥æ‚¨æ•°æ®æ–‡ä»¶çš„**ç»å¯¹è·¯å¾„**ã€‚

```python
# ä½äº config.py
@dataclass
class DataConfig:
    # --- å°†ä¸‹é¢ä¸‰è¡Œä¿®æ”¹ä¸ºæ‚¨çš„å®é™…æ–‡ä»¶è·¯å¾„ ---
    song_info_file: str = "/path/to/your/gen_song_info.csv"
    playlist_info_file: str = "/path/to/your/gen_playlist_info.csv"
    playlist_songs_file: str = "/path/to/your/gen_playlist_song.csv"
    ...

@dataclass
class SongRQVAEConfig:
    # --- å°†ä¸‹é¢è¿™è¡Œä¿®æ”¹ä¸ºæ‚¨çš„æ–‡ä»¶è·¯å¾„ ---
    song_vector_file: str = "/path/to/your/song_vectors.csv"
    ...
```

## ğŸš€ æ‰§è¡Œæ­¥éª¤

è¯·åœ¨é¡¹ç›®æ ¹ç›®å½•ï¼ˆ`generate_playlist`ï¼‰ä¸‹ï¼Œä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹é¡ºåºæ‰§è¡Œè„šæœ¬ã€‚

### **é˜¶æ®µ1: ç”Ÿæˆæ­Œæ›²è¯­ä¹‰ID**

*   **å‘½ä»¤**: `python train_rqvae.py`
*   **è¾“å‡º**: `models/song_rqvae_best.pt` å’Œ `outputs/song_semantic_ids.jsonl`ã€‚
*   **æ£€æŸ¥**: ç¡®ä¿ `outputs/` ç›®å½•ä¸‹å·²ç”Ÿæˆ `song_semantic_ids.jsonl` æ–‡ä»¶ã€‚

---

### **é˜¶æ®µ1b (å¯é€‰): è¯„ä¼°è¯­ä¹‰IDè´¨é‡**

*   **å‘½ä»¤**: `python evaluate_rqvae.py`
*   **è¾“å‡º**: ç»ˆç«¯ä¼šæ‰“å°ä¸€ä»½è´¨é‡æŠ¥å‘Šã€‚
*   **æ£€æŸ¥**: å…³æ³¨æŠ¥å‘Šä¸­çš„ **`Average Cosine Similarity`** æŒ‡æ ‡ï¼Œå»ºè®®è¯¥å€¼ > 0.8ã€‚

---

### **é˜¶æ®µ2: ç”Ÿæˆè®­ç»ƒè¯­æ–™**

*   **å‘½ä»¤**: `python prepare_corpus.py`
*   **è¾“å‡º**: `outputs/train.tsv`, `outputs/val.tsv`, `outputs/test.tsv`ã€‚
*   **æ£€æŸ¥**: ç¡®ä¿ `outputs/` ç›®å½•ä¸‹å·²ç”Ÿæˆè¿™ä¸‰ä¸ª `.tsv` æ–‡ä»¶ã€‚

---

### **é˜¶æ®µ3: è®­ç»ƒT5ç”Ÿæˆæ¨¡å‹**

*   **å‘½ä»¤ (å¤šGPU, æ¨è)**:
    ```bash
    # å°† [GPUæ•°é‡] æ›¿æ¢ä¸ºæ‚¨çš„GPUå¡æ•°, ä¾‹å¦‚ 4
    torchrun --nproc_per_node=[GPUæ•°é‡] train_tiger.py
    ```
*   **å‘½ä»¤ (å•GPU)**: `python train_tiger.py`
*   **è¾“å‡º**: æœ€ç»ˆæ¨¡å‹ `models/tiger_final/`ã€‚
*   **æ£€æŸ¥**: ç¡®ä¿ `models/` ç›®å½•ä¸‹å·²ç”Ÿæˆ `tiger_final` æ–‡ä»¶å¤¹ã€‚

---

### **é˜¶æ®µ4 (å¯é€‰): è¯„ä¼°T5æ¨¡å‹**

*   **å‘½ä»¤**: `python evaluate_tiger.py`
*   **è¾“å‡º**: ç»ˆç«¯ä¼šæ‰“å°ä¸€ä»½åŒ…å« ROUGE, BLEU, F1-Score çš„è¯„ä¼°æŠ¥å‘Šã€‚
*   **æ£€æŸ¥**: å…³æ³¨ **`Avg. F1-Score`** æŒ‡æ ‡ï¼Œå®ƒç›´è§‚åœ°åæ˜ äº†ç”Ÿæˆæ­Œå•å†…å®¹çš„å‡†ç¡®æ€§ã€‚

---

### **é˜¶æ®µ5: äº¤äº’å¼æ¨ç†æ¼”ç¤º**

*   **å‘½ä»¤**: `python generate_playlist.py`
*   **è¾“å‡º**: ä¸€ä¸ªäº¤äº’å¼çš„å‘½ä»¤è¡Œç•Œé¢ï¼Œè¾“å…¥æ ‡é¢˜å³å¯ç”Ÿæˆæ­Œå•ã€‚
